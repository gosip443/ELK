[toc]

# ZooKeeper基础与入门

## ZooKeeper 概念介绍

在介绍 ZooKeeper 之前，先来介绍一下分布式协调技术，是一位分布式协调技术主要用来解决分布式环境中的一个进程之间的同步控制，让它们有序的去访问某种共享资源，防止造成资源竞争（脑裂）的后果。

这里首先介绍一下什么是分布式系统，所谓分布式系统就是在不同的地域分布的多个服务器，共同组成一个应用系统来为客户提供服务，在分布式系统中最重要的是进程的调度，这里假设有一个分布在三个地域的服务器组成一个应用系统，在第一台机器上挂载了一个资源，然后这三个地域分布的应用进程都要竞争这个资源，但我们又不希望多个进程同时进行访问，这个时候就需要一个协调器，来让它们有序的访问这个资源。这个协调器就是分布式系统中经常提到的 “锁” 。

<img src="images/3.ZooKeeper%E5%9F%BA%E7%A1%80%E4%B8%8E%E5%85%A5%E9%97%A8.assets/%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81.png" alt="分布式锁" style="zoom: 80%;" />

**解释**

例如 进程① 在使用资源的时候，会先去获取 “锁”，进程① 获得锁以后对该资源保持独占，此时其他进程无法访问该资源，进程① 在使用完该资源后会将锁释放掉，以便让其他进程获得锁。由此可见，通过这个 “锁” 机制，就可以保证分布式系统中多个进程能够有序的访问共享资源。这里把这个分布式环境下的这个 “锁” 叫做分布式锁。**这个分布式锁就是分布式协调技术实现的核心内容**

综上所述，ZooKeeper是一种为分布式应用所设计的高可用、高性能的开源协调服务，它提供了一项基本服务：**分布式锁服务**，同时也提供了数据的维护和管理机制，如：统一命名服务、状态同步服务、集群管理、分布式消息队列、分布式应用配置项管理等等。

## ZooKeeper 应用举例

这里以 ZooKeeper 提供的基本服务分布式锁为例进行介绍。在分布式锁服务中，有一种典型的应用场景，就是通过对集群 Master 角色的选举，来解决分布式系统中的单点故障问题。所谓单点故障，就是在一个主从的分布式系统中，主节点负责任务调度分发，从节点负责任务的处理，当主节点发生故障时，整个系统也就瘫痪了，这种故障称为单点故障。

解决单点故障的，传统的方法时采用一个备用节点，这个备用节点定期向主节点发送 Ping 包，主节点收到 Ping 包后向备用节点发送回复 ACK 信息，当备用节点收到回复就认为当前主节点运行正常。当主节点发生故障时，备用节点无法收到回复信息，此时备用节点认为主节点宕机，然后接替它成为新的主节点继续提供服务。

![双机热备](images/3.ZooKeeper%E5%9F%BA%E7%A1%80%E4%B8%8E%E5%85%A5%E9%97%A8.assets/%E5%8F%8C%E6%9C%BA%E7%83%AD%E5%A4%87.png)

以上传统的解决饭店故障的方法，虽然在一定程度上解决了问题，但有一个隐患，就是网络问题，可能会存在这样一种情况：主节点并没有出现故障，知识在回复 ACK 响应的时候网络发生了故障，这样备用节点就无法收到回复，那么它就会认为主节点发生了故障，接着备用节点接管主节点的服务，并成为新的主节点。此时，分布式系统中出现了两个主节点的情况，双 Master 节点的出现，会导致分布式系统的服务发生混乱。这样的话，整个分布式系统将变得不可用。为了防止这种情况发生，就需要引入 ZooKeeper 来解决着这种问题。

## Zookeeper 工作原理

通过以下三种情景，介绍 Zookeeper 工作原理

Master 启动

在分布式系统中引入 Zookeeper 后，可以配置多个主节点，以两个主节点为例，假定它们时 主节点 A 和 主节点 B ，当这两个节点都启动后，它们都会向 Zookeeper 中注册节点信息，这里假设 主节点 A 锁注册的节点信息是“Master00001”，主节点 B 注册的节点信息是“Master00002”，注册完以后会进行选举，选举有多种算法，这里以编号最小作为选举算法，那么编号小的 A 在选举中获胜并获得锁成为主节点，然后 主节点 B 将被阻塞成为一个备用节点。通过这样的方式，ZooKeeper 就完成了对两个 Master 进程的调度，完成了主、备节点的分配和协调。

<img src="images/3.ZooKeeper%E5%9F%BA%E7%A1%80%E4%B8%8E%E5%85%A5%E9%97%A8.assets/ZooKeeper.png" alt="ZooKeeper" style="zoom: 80%;" />





Master 故障

如果 主节点 A 发生故障，这时 A 在 ZooKeeper 中注册的节点信息会被删除，而 ZooKeeper 会自动感知节点的变化，发现 主节点 A 故障后，会再次发出选举，这时 主节点 B 在选举中获胜，替代 主节点 A 成为新的主节点，这样就完成了主、被节点的重新选举。



Master 恢复

如果主节点恢复了，它会再次向 ZooKeeper 注册自己的节点信息，只不过这个时候它的注册信息就变成了 “master00003”，主节点 A 会担任备用节点。

ZooKeeper 就是通过这样的协调、调度机制如此反复的对集群进行管理和状态同步。



















